# CivicForge V2 — Penetration Test Report V2

**Version:** 2.0
**Date:** 2026-02-07
**Tester:** Automated SAST (Semgrep) + DAST (nuclei/httpx) + Targeted Dynamic Testing
**Scope:** All server-side code, RLS policies, API routes, client components, and production deployment (civicforge.org)
**Branch:** main
**Predecessor:** docs/PENTEST_REPORT.md (V1 — static analysis only)
**Threat Model Reference:** docs/THREAT_MODEL.md

---

## 1. Executive Summary

This is the second penetration test of CivicForge V2, building on the V1 static analysis report. V1 found and fixed PT-01 through PT-05. This report adds **automated SAST** (Semgrep), **dynamic application security testing** (DAST) from an external AWS host, and **targeted live verification** of specific hypotheses from code review.

The production deployment at civicforge.org demonstrates a **strong security posture**. Semgrep found **zero new vulnerabilities** across 107 files scanned with 9 security-focused rulesets. Dynamic testing confirmed all V1 fixes hold under live conditions. Six hypotheses (H1–H6) were tested; three were confirmed as new findings, two were refuted, and one was confirmed but mitigated by existing controls.

**New Findings Summary:**
- **Critical:** 0
- **High:** 0
- **Medium:** 1 new (PT-06: `unsafe-inline` in script-src CSP)
- **Low:** 3 new (PT-07: phone verify missing rate limit, PT-08: privacy endpoints missing rate limit, PT-09: SVG MIME accepted in photo upload)
- **Info:** 4 new observations

**Previous Findings (V1):** PT-01 through PT-05 all verified as fixed in production.

---

## 2. Methodology

### 2.1 Semgrep SAST (WS1)

Automated static analysis with Semgrep v1.146.0 using 9 security rulesets:

```
p/nextjs, p/react, p/typescript, p/owasp-top-ten, p/security-audit,
p/secrets, p/xss, p/sql-injection, p/command-injection
```

- **Files scanned:** 107
- **Exclusions:** `node_modules/`, `.next/`
- **Result:** 0 findings, 3 parser errors (JSX `&` character in text content — false positives in Semgrep's TSX parser)

### 2.2 DAST from AWS (WS2)

External scanning from fabric-server (AWS us-east-2, 18.188.129.95):

- **httpx v1.6.10** — Header fingerprinting and tech detection against civicforge.org
- **nuclei v3.3.7** — Template-based vulnerability scanning (attempted; server became unresponsive during scan, partial results obtained via httpx)
- **Target:** civicforge.org (production, Vercel)
- **Note:** dev.civicforge.org was unreachable during testing (no HTTP response)

### 2.3 Targeted Dynamic Tests (WS3)

Live verification of 9 specific test cases against civicforge.org using curl. Each test targeted a specific hypothesis from code review that required live verification.

| # | Test | Method | Result |
|---|------|--------|--------|
| 3.1 | Open redirect bypass variants | curl -sI with encoded payloads | **PASS** — all variants redirect to `/login?error=auth_failed` |
| 3.2 | Security headers verification | curl -sI header inspection | **FINDING** — `unsafe-inline` in script-src confirmed |
| 3.3 | CORS behavior | curl with `Origin: https://evil.com` | **PASS** — no CORS headers on API routes |
| 3.4 | Cookie security attributes | curl Set-Cookie inspection | **PASS** — Supabase SSR defaults to HttpOnly, Secure, SameSite=Lax |
| 3.5 | SVG MIME acceptance in photo upload | Node.js Sharp test | **FINDING** — SVG accepted but safely rasterized to JPEG |
| 3.6 | Error response leakage | Malformed requests to API routes | **PASS** — generic errors, no stack traces |
| 3.7 | Cron endpoint auth | curl without/with wrong Bearer token | **PASS** — returns 401 Unauthorized |
| 3.8 | Supabase RLS direct test | PostgREST queries with anon key | **PASS** — all reads return empty, writes blocked by RLS |
| 3.9 | Source map exposure | curl for .map files | **PASS** — all return 404 |

---

## 3. New Findings

### PT-06: `unsafe-inline` in CSP `script-src` Weakens XSS Defense (MEDIUM)

- **Severity:** MEDIUM
- **Hypothesis:** H1 (confirmed)
- **Location:** `middleware.ts:13`
- **Description:** The Content-Security-Policy sets `script-src 'self' 'unsafe-inline'`. While V1 correctly removed `unsafe-eval`, `unsafe-inline` remains in the `script-src` directive. This allows execution of inline `<script>` tags and inline event handlers, significantly weakening the CSP's ability to prevent XSS. If an attacker finds a way to inject HTML into the page (e.g., through a future sanitization bypass), inline scripts would execute despite CSP.
- **Live Evidence:**
  ```
  content-security-policy: default-src 'self'; script-src 'self' 'unsafe-inline'; ...
  ```
  Verified on production via `curl -sI https://civicforge.org`.
- **Impact:** Reduces CSP from a strong XSS prevention control to merely a defense-in-depth layer. The primary XSS defense relies entirely on React's auto-escaping and the `sanitizeOutput()` regex, rather than having CSP as an independent safety net.
- **Remediation:** Implement nonce-based CSP for scripts:
  1. Generate a cryptographic nonce per request in middleware
  2. Set `script-src 'self' 'nonce-<value>'` instead of `'unsafe-inline'`
  3. Pass the nonce to Next.js via the `nonce` prop on `<Script>` components
  4. Note: This requires testing with all inline scripts in the application
- **Status:** OPEN

### PT-07: Phone Verify Endpoint Missing Rate Limiting (LOW)

- **Severity:** LOW
- **Hypothesis:** H5 (confirmed)
- **Location:** `app/api/phone/verify/route.ts`
- **Description:** The `/api/phone/send` endpoint has Upstash rate limiting (3 requests/hour/user), but the `/api/phone/verify` endpoint has no rate limiting. An attacker who obtains a valid OTP send could brute-force the 6-digit verification code (1,000,000 combinations) without throttling. Twilio Verify has its own server-side rate limiting and lockout after ~5 failed attempts, which mitigates the worst case, but the application layer should enforce its own limits.
- **Impact:** Low because Twilio Verify has built-in lockout after repeated failures. However, relying solely on a third-party's rate limiting is a defense-in-depth gap.
- **Remediation:** Add Upstash rate limiting to `/api/phone/verify` (e.g., 5 attempts per 15 minutes per user), matching the pattern already established in `/api/phone/send`.
- **Status:** OPEN

### PT-08: Privacy Endpoints Missing Rate Limiting (LOW)

- **Severity:** LOW
- **Hypothesis:** H6 (confirmed)
- **Location:** `app/api/privacy/delete/route.ts`, `app/api/privacy/export/route.ts`
- **Description:** The data export (`GET /api/privacy/export`) and account deletion (`POST /api/privacy/delete`) endpoints have no rate limiting. While both require authentication, a compromised account or malicious authenticated user could repeatedly trigger data exports (potentially expensive database queries) or deletion requests.
- **Impact:** Low — both endpoints require valid authentication and the deletion endpoint is idempotent (re-requesting deletion when one is already pending is a no-op at the application level). The export endpoint could cause elevated database load if spammed.
- **Remediation:** Add Upstash rate limiting: export at 3 requests/hour/user, deletion at 1 request/day/user.
- **Status:** OPEN

### PT-09: Photo Upload Accepts SVG MIME Type (LOW)

- **Severity:** LOW
- **Hypothesis:** H4 (confirmed, mitigated)
- **Location:** `app/api/photos/upload/route.ts:31`
- **Description:** The MIME type check `file.type.startsWith("image/")` matches `image/svg+xml`, allowing SVG files to pass the initial validation. Sharp accepts SVG input, reads its dimensions, and converts it to JPEG. The `isValidImage()` utility function in `lib/photos/process.ts` would reject SVG (since "svg" is not in the allowed formats list), but **this function is never called in the upload route**.
- **Proof of Concept:**
  ```javascript
  // SVG with <script> tag passes MIME check and Sharp processing
  const svgBuffer = Buffer.from('<svg xmlns="..." width="100" height="100"><script>alert(1)</script></svg>');
  const metadata = await sharp(svgBuffer).metadata(); // format: "svg", succeeds
  const jpeg = await sharp(svgBuffer).jpeg().toBuffer(); // converts to JPEG, script stripped
  ```
- **Impact:** Low — the SVG is always rasterized to JPEG by Sharp, stripping all script/XML content. The stored file is a valid JPEG with no executable content. However, accepting SVG input is a defense-in-depth gap: if Sharp's SVG rendering has vulnerabilities (e.g., XXE in libvips/librsvg), a crafted SVG could exploit the server-side rendering pipeline.
- **Remediation:** Add explicit SVG rejection before Sharp processing:
  ```typescript
  if (file.type === "image/svg+xml") {
    return NextResponse.json({ error: "SVG files are not accepted" }, { status: 400 });
  }
  ```
- **Status:** OPEN

---

## 4. Informational Observations

### INFO-04: Vercel Adds `Access-Control-Allow-Origin: *` on Static Pages

- **Location:** Vercel edge (not in application code)
- **Observation:** Production responses for static/prerendered pages (e.g., `/`, `/login`) include `access-control-allow-origin: *`. This is Vercel's default behavior for static assets. API routes and authenticated pages do NOT include this header.
- **Risk:** Minimal — `Access-Control-Allow-Origin: *` without `Access-Control-Allow-Credentials: true` means browsers will not send cookies cross-origin. The wildcard only applies to publicly accessible, non-authenticated content (landing page, login page). No sensitive data is exposed.
- **Recommendation:** No action needed. This is expected Vercel behavior for static content.

### INFO-05: Vercel Provides HSTS (Not Set in Application Code)

- **Location:** Vercel edge (not in `middleware.ts`)
- **Observation:** The `strict-transport-security: max-age=63072000` header is present on all production responses, despite not being set in the application's middleware. Vercel automatically adds HSTS with a 2-year max-age on all HTTPS responses. This refutes hypothesis H2 — HSTS is present in production even though the middleware doesn't set it.
- **Risk:** None — this is the desired behavior. However, the application should not rely solely on Vercel's edge behavior. If the app were deployed elsewhere, HSTS would be missing.
- **Recommendation:** Consider adding `Strict-Transport-Security` to the middleware headers for deployment portability.

### INFO-06: Missing Cross-Origin Isolation Headers (COEP/COOP/CORP)

- **Location:** `middleware.ts` (headers not set); confirmed by nuclei scan
- **Observation:** The following optional security headers are not set: `Cross-Origin-Embedder-Policy`, `Cross-Origin-Opener-Policy`, `Cross-Origin-Resource-Policy`. These headers enable cross-origin isolation, which prevents Spectre-type side-channel attacks and is required for `SharedArrayBuffer` usage.
- **Risk:** Minimal for CivicForge — the app does not use `SharedArrayBuffer` or other APIs that require cross-origin isolation. These are defense-in-depth headers.
- **Recommendation:** Consider adding in a future hardening pass: `Cross-Origin-Opener-Policy: same-origin`, `Cross-Origin-Embedder-Policy: require-corp`, `Cross-Origin-Resource-Policy: same-origin`. Note: COEP `require-corp` may break cross-origin image loading from Supabase Storage — test before deploying.

### INFO-07: dev.civicforge.org Unreachable

- **Observation:** During testing, `dev.civicforge.org` returned no HTTP response on either HTTP or HTTPS. No headers, no connection, no timeout error — the domain appears to have no active deployment.
- **Risk:** If the dev environment has been decommissioned, the DNS record should be removed to prevent subdomain takeover. If it's temporarily down, it should be restored and tested.
- **Recommendation:** Either restore the dev environment or remove the `dev.civicforge.org` DNS record.

---

## 5. Hypothesis Verification

| # | Hypothesis | Severity | Result | Evidence |
|---|-----------|----------|--------|----------|
| H1 | `unsafe-inline` in `script-src` CSP weakens XSS defense | MEDIUM | **CONFIRMED** → PT-06 | `curl -sI` shows `script-src 'self' 'unsafe-inline'` on all responses |
| H2 | Missing HSTS header | LOW | **REFUTED** | Vercel adds `strict-transport-security: max-age=63072000` at edge → INFO-05 |
| H3 | CSRF on membership approve/deny API routes | MEDIUM | **REFUTED** | Supabase SSR sets `SameSite=Lax` cookies by default. Cross-origin POST forms cannot send cookies. Additionally, the routes use `getUser()` which validates the auth token server-side. |
| H4 | Photo upload accepts SVG MIME → stored XSS | MEDIUM | **CONFIRMED (mitigated)** → PT-09 | SVG passes MIME check and Sharp processing, but is always converted to JPEG. No script content survives. Risk lowered to LOW. |
| H5 | Phone verify lacks rate limiting → OTP brute-force | MEDIUM | **CONFIRMED** → PT-07 | Code review confirms no `Ratelimit` import in verify route. Risk lowered to LOW due to Twilio's built-in lockout. |
| H6 | Privacy endpoints lack rate limiting | LOW | **CONFIRMED** → PT-08 | Code review confirms no `Ratelimit` import in delete or export routes. |

---

## 6. SAST Results (Semgrep)

| Metric | Value |
|--------|-------|
| Tool | Semgrep v1.146.0 (OSS engine) |
| Rulesets | 9 (nextjs, react, typescript, owasp-top-ten, security-audit, secrets, xss, sql-injection, command-injection) |
| Files scanned | 107 |
| Findings | **0** |
| Parser errors | 3 (JSX `&` in text — Semgrep false positives) |

The zero-finding result is consistent with the manual code review in V1, which found the codebase follows security best practices: no `dangerouslySetInnerHTML`, no raw SQL, no hardcoded secrets, proper auth patterns, and Zod validation throughout.

---

## 7. DAST Results

### 7.1 httpx (from fabric-server, 18.188.129.95)

| Target | Status | Tech | Server |
|--------|--------|------|--------|
| civicforge.org | 200 | HSTS, Vercel | Vercel |
| dev.civicforge.org | No response | — | — |

**Production Header Analysis:**

| Header | Value | Assessment |
|--------|-------|------------|
| `content-security-policy` | `default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' blob: data: *.supabase.co; font-src 'self'; connect-src 'self' *.supabase.co; frame-ancestors 'none'; base-uri 'self'; form-action 'self'` | `unsafe-inline` in script-src is a gap (PT-06); style-src `unsafe-inline` is acceptable for Tailwind |
| `strict-transport-security` | `max-age=63072000` | Strong (2-year HSTS, added by Vercel) |
| `x-frame-options` | `DENY` | Correct |
| `x-content-type-options` | `nosniff` | Correct |
| `referrer-policy` | `strict-origin-when-cross-origin` | Correct |
| `permissions-policy` | `camera=(), microphone=(), geolocation=()` | Correct |
| `server` | `Vercel` | Acceptable — reveals hosting provider but not version info |
| `x-powered-by` | Not present | Correct |
| `access-control-allow-origin` | `*` (static pages only) | Acceptable — see INFO-04 |

### 7.2 nuclei (from fabric-server, 18.188.129.95)

Nuclei v3.3.7 with nuclei-templates v10.3.8. Initial runs with full template directories (`http/misconfiguration/`, `http/exposures/`, `http/technologies/`, `http/cves/`) caused resource exhaustion on the t2.micro instance (957MB RAM, no swap). After rebooting and switching to targeted templates, 15 specific templates were executed successfully covering: security headers, CSP weaknesses, CORS misconfig, Next.js CVEs (CVE-2025-29927, CVE-2025-55182, CVE-2025-55184, CVE-2024-34351), Next.js cache poisoning, Vercel source exposure, and config file leaks.

**Findings:**

| Template | Severity | Finding |
|----------|----------|---------|
| `weak-csp-detect:script-src-directive` | INFO | `script-src 'self' 'unsafe-inline'` — confirms PT-06 |
| `weak-csp-detect:default-src-directive` | INFO | `default-src 'self'` — informational, correct |
| `http-missing-security-headers:x-permitted-cross-domain-policies` | INFO | Missing header (optional for non-Flash apps) |
| `http-missing-security-headers:clear-site-data` | INFO | Missing header (used for logout cache clearing) |
| `http-missing-security-headers:cross-origin-embedder-policy` | INFO | Missing COEP header |
| `http-missing-security-headers:cross-origin-opener-policy` | INFO | Missing COOP header |
| `http-missing-security-headers:cross-origin-resource-policy` | INFO | Missing CORP header |

**No matches (clean):**
- CVE-2025-29927 (Next.js middleware bypass) — not vulnerable
- CVE-2025-55182, CVE-2025-55184 (Next.js vulnerabilities) — not vulnerable
- CVE-2024-34351 (Next.js SSRF) — not vulnerable
- CORS misconfiguration — not vulnerable
- Vercel source exposure — not vulnerable
- Next.js config file exposure — not vulnerable
- Next.js RSC cache / cache poisoning / middleware cache — not vulnerable
- Vercel storage CSP bypass — not vulnerable

**Assessment:** All nuclei findings are INFO severity. The missing COEP/COOP/CORP headers are optional hardening for cross-origin isolation (relevant if using `SharedArrayBuffer` or wanting to prevent Spectre-type side channels). They are not required for CivicForge's use case but could be added as future hardening.

---

## 8. Previous Finding Verification

All V1 findings (PT-01 through PT-05) were verified as fixed in production:

| ID | Finding | V1 Status | V2 Verification |
|----|---------|-----------|-----------------|
| PT-01 | Audit log silent failure in unflagPost | Fixed | **Verified** — `createServiceClient()` used for audit inserts |
| PT-02 | Open redirect in auth callback | Fixed | **Verified** — 8 bypass variants tested (URL-encoded, backslash, tab/newline injection, triple slash). All redirect to `/login?error=auth_failed` rather than following the malicious `next` parameter. |
| PT-03 | PostgREST filter injection in community search | Fixed | **Verified** — sanitization strips special PostgREST characters |
| PT-04 | Math.random() for invite codes | Fixed | **Verified** — `crypto.getRandomValues()` used |
| PT-05 | Missing UUID validation on AI match route | Fixed | **Verified** — Zod UUID validation added |

### RLS Verification (Test 3.8)

Direct PostgREST queries with the public anon key confirmed RLS enforcement:

| Table | Unauthenticated Read | Unauthenticated Write |
|-------|---------------------|-----------------------|
| profiles | `[]` (empty — blocked) | `42501: row-level security policy violation` |
| posts | `[]` (empty — blocked) | Not tested |
| audit_log | `[]` (empty — blocked) | Not tested |
| ai_matches | `[]` (empty — blocked) | Not tested |
| communities | `[]` (empty — blocked) | Not tested |
| invitations | `[]` (empty — blocked) | Not tested |

### Cron Endpoint Auth (Test 3.7)

| Request | Response |
|---------|----------|
| GET without auth | `{"error":"Unauthorized"}` (401) |
| GET with wrong token | `{"error":"Unauthorized"}` (401) |
| POST without auth | `{"error":"Unauthorized"}` (401) |

### Error Leakage (Test 3.6)

| Request | Response |
|---------|----------|
| Malformed JSON to `/api/ai/match` | Empty response (no stack trace) |
| Invalid UUID to membership route | Empty response (no stack trace) |
| Missing body to `/api/phone/verify` | `{"error":"Unauthorized"}` (generic) |
| Wrong content-type to `/api/photos/upload` | `{"error":"Unauthorized"}` (generic) |

All error responses are generic with no implementation details leaked.

---

## 9. Threat Model Validation Update

Updates to the STRIDE threat model (docs/THREAT_MODEL.md) based on V2 findings:

| ID | V1 Status | V2 Update |
|----|-----------|-----------|
| V1 (CSP unsafe-eval) | FIXED | Confirmed fixed. However, `unsafe-inline` in `script-src` remains (PT-06). |
| V2 (AI match anon client) | FIXED | Confirmed fixed in production. |
| V3 (Audit log anon client) | FIXED | Confirmed fixed in production. |
| V4 (Invitation RLS) | FIXED | Confirmed fixed. RLS blocks unauthenticated reads. |
| V5 (Regex XSS sanitizer) | FIXED | Confirmed fixed. Enhanced regex covers SVG, math, style, link, meta, base tags. |
| V6 (Photo moderation fails open) | FIXED | Confirmed. SightEngine integration fails closed in production. |
| V7 (AI token budget) | KNOWN GAP | Unchanged — still not enforced. |
| **NEW: TB4-D1** (SMS rate limiting) | PARTIAL | `/api/phone/send` has rate limiting; `/api/phone/verify` does not (PT-07). |

---

## 10. Recommendations (Prioritized)

### Priority 1 — Before Production Launch

1. **(PT-09) Reject SVG uploads explicitly** — Add `file.type === "image/svg+xml"` check before Sharp processing. One-line fix with no functional impact.

### Priority 2 — Near-Term Hardening

2. **(PT-06) Implement nonce-based CSP for scripts** — Replace `script-src 'self' 'unsafe-inline'` with `script-src 'self' 'nonce-<value>'`. This is the highest-impact security improvement available but requires testing all inline scripts.
3. **(PT-07) Add rate limiting to phone verify** — Copy the Upstash rate limiting pattern from `/api/phone/send` to `/api/phone/verify` (5 attempts per 15 min).
4. **(PT-08) Add rate limiting to privacy endpoints** — Add Upstash rate limiting to `/api/privacy/export` (3/hour) and `/api/privacy/delete` (1/day).
5. **(INFO-05) Add HSTS to middleware** — Set `Strict-Transport-Security` in middleware for deployment portability, not just relying on Vercel's edge.

### Priority 3 — Future Improvements

6. **(INFO-07) Resolve dev.civicforge.org** — Either restore the dev environment or remove the DNS record to prevent subdomain takeover.
7. **(INFO-06) Add cross-origin isolation headers** — Set COOP, COEP, CORP headers for Spectre mitigation (test COEP with Supabase Storage images first).
8. **Replace regex sanitizer with DOMPurify** — The regex-based `sanitizeOutput()` is enhanced but inherently limited. A DOM-based sanitizer provides comprehensive XSS prevention (carried forward from V1).
9. **Enforce AI token budget** — V7 remains unresolved; `AI_DAILY_TOKEN_BUDGET` defined but never checked (carried forward from V1).
10. **Add rate limiting to photo upload** — Currently no rate limit on `/api/photos/upload`; consider 10 uploads/hour/user.

---

## 11. Test Coverage Summary

| Test Category | Coverage | Tools |
|--------------|----------|-------|
| Static analysis (SAST) | 107 files, 9 rulesets | Semgrep v1.146.0 |
| Header security | All response headers verified | curl, httpx |
| CORS policy | 5 routes tested with malicious Origin | curl |
| Cookie security | SameSite, HttpOnly, Secure verified | curl, code review |
| Open redirect | 8 bypass variants tested | curl |
| RLS enforcement | 6 tables tested unauthenticated | PostgREST direct |
| Error leakage | 4 malformed request patterns | curl |
| Source map exposure | 5 chunks + 3 common patterns | curl |
| Cron auth | 3 unauthorized access patterns | curl |
| Photo upload (SVG) | MIME check + Sharp behavior | Node.js test |
| Rate limiting gaps | All API routes audited | Code review |

---

## 12. Files Referenced

| File | Relevance |
|------|-----------|
| `middleware.ts` | CSP headers (PT-06), HSTS gap (INFO-05), auth enforcement |
| `app/api/photos/upload/route.ts` | SVG MIME acceptance (PT-09) |
| `app/api/phone/verify/route.ts` | Missing rate limit (PT-07) |
| `app/api/phone/send/route.ts` | Rate limit pattern reference |
| `app/api/privacy/delete/route.ts` | Missing rate limit (PT-08) |
| `app/api/privacy/export/route.ts` | Missing rate limit (PT-08) |
| `app/api/privacy/process-deletions/route.ts` | Cron auth verification |
| `app/api/auth/callback/route.ts` | Open redirect bypass testing |
| `app/api/membership/[requestId]/approve/route.ts` | CSRF analysis (H3 — refuted) |
| `lib/ai/sanitize.ts` | XSS sanitizer review |
| `lib/photos/process.ts` | Sharp SVG handling analysis |
| `lib/supabase/middleware.ts` | Cookie attribute analysis |
